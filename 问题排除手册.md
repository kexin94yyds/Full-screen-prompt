# Prompter - 问题排除手册

本文档记录了使用 Prompter Mac 应用时遇到的典型问题及解决方案。

---

## 目录

1. [辅助功能权限问题 (错误 1002)](#1-辅助功能权限问题-错误-1002)
2. [应用启动相关问题](#2-应用启动相关问题)
3. [应用改名后插入功能失效](#3-应用改名后插入功能失效)
4. [应用更新后新功能未生效](#4-应用更新后新功能未生效)
5. [电脑重启后应用异常](#5-电脑重启后应用异常)
6. [代码更新后打包版本未生效](#6-代码更新后打包版本未生效)

---

## 1. 辅助功能权限问题 (错误 1002)

### 🔴 问题描述

使用"插入"功能时出现以下错误：

```
Error: Command failed: osascript -e '...'
execution error: "System Events"遇到一个错误："osascript"不允许发送按键。 (1002)
```

或应用弹出对话框：

```
macOS 拒绝了自动粘贴（辅助功能权限未开启）
```

**症状：**
- 点击提示词后无法自动粘贴到光标位置
- 按 `Enter` 键选择提示词后没有反应
- 内容已复制到剪贴板，但不会自动粘贴

### 🔍 问题原因

macOS 的安全机制要求应用必须获得"辅助功能"权限才能模拟键盘操作（如自动按下 `⌘V` 粘贴）。

**关键点：**
- 从**终端启动**的 Electron 应用，系统检查的是**终端**的权限，而不是应用本身
- 即使在系统设置中给了权限，**必须重启被授权的程序**才能生效
- 终端的权限问题非常容易出现，因为权限链比较复杂

### ✅ 解决方案（推荐）：使用独立打包的应用

#### 方案一：直接使用已打包的应用（最简单）

1. **找到打包好的应用**
   ```
   位置: dist/mac-arm64/Prompter.app
   ```

2. **将应用移到"应用程序"文件夹**
   - 把 `Prompter.app` 拖到 `/Applications` 文件夹（可选，但推荐）

3. **首次启动**
   - 双击 `Prompter.app`
   - 如果出现"无法打开，因为无法验证开发者"：
     - 右键点击应用
     - 选择"打开"
     - 在弹出对话框中再次点击"打开"

4. **授权辅助功能**
   - 首次使用"插入"功能时，会弹出对话框
   - 点击"打开设置"按钮
   - 在系统设置中找到并勾选 **"Prompter"**
   - **无需重启应用**，权限立即生效！

5. **后续使用**
   - 按 `Shift + ⌘ + O` 呼出窗口
   - 应用会在后台常驻

#### 方案二：重新打包应用（如果应用文件丢失）

```bash
cd "/Users/apple/mac 提示词库/Slash-Command-Prompter"
npm run build
```

打包完成后，应用位于：`dist/mac-arm64/Prompter.app`

### ⚠️ 不推荐的方案：从终端启动并授权

如果坚持从终端启动（仅限开发调试），需要：

1. **打开系统设置**
   ```bash
   open "x-apple.systempreferences:com.apple.preference.security?Privacy_Accessibility"
   ```

2. **移除并重新添加终端**
   - 在辅助功能列表中，选中"终端"，点击 `-` 移除
   - 点击 `+` 按钮
   - 导航到 `/System/Applications/Utilities/Terminal.app`
   - 添加后确保开关是开启状态

3. **完全退出并重启终端**（关键步骤）
   - 按 `⌘Q` 退出终端（不是只关闭窗口）
   - 重新打开终端

4. **测试权限是否生效**
   ```bash
   osascript -e 'tell application "System Events" to keystroke "a"'
   ```
   - 无错误 = 权限已生效
   - 仍然报 1002 错误 = 需重复上述步骤

5. **启动应用**
   ```bash
   cd "/Users/apple/mac 提示词库/Slash-Command-Prompter"
   npm start
   ```

### 📊 方案对比

| 特性 | 独立应用 (.app) | 终端启动 |
|------|----------------|---------|
| 权限授予对象 | ✅ "Prompter"本身 | ⚠️ 终端 |
| 是否需要重启 | ❌ 不需要 | ✅ 必须重启终端 |
| 启动方式 | ✅ 双击图标 | ⚠️ 每次运行命令 |
| 权限稳定性 | ✅ 非常稳定 | ⚠️ 容易出问题 |
| 推荐度 | ⭐⭐⭐⭐⭐ | ⭐⭐ |

### 💡 最佳实践

1. **开发阶段**：可以从终端启动进行调试
2. **日常使用**：使用打包好的 `.app` 文件
3. **代码修改后**：重新运行 `npm run build` 打包即可

---

## 2. 应用启动相关问题

### 🔴 问题：JavaScript 错误 "write EIO"

**错误信息：**
```
Uncaught Exception:
Error: write EIO
at afterWriteDispatched (node:internal/stream_base_commons:160:15)
...
```

**原因：**
- 尝试向已销毁的窗口发送消息
- 窗口状态检查不足

**解决方案：**
此问题已在代码中修复，确保使用最新版本的 `main.js`，其中包含：
- 窗口销毁检查：`mainWindow && !mainWindow.isDestroyed()`
- 所有 IPC 通信都有 try-catch 保护
- 窗口操作前验证窗口状态

### 🔴 问题：快捷键不起作用

**可能原因：**
1. 快捷键被其他应用占用
2. 应用未在后台运行
3. 有多个实例在运行

**解决方案：**
1. 检查活动监视器中是否有"提示词库"或"Electron"进程
2. 确保只有一个实例在运行（代码已实现单实例锁）
3. 尝试更换快捷键（需修改 `main.js` 中的 `globalShortcut.register`）

### 🔴 问题：窗口不显示或闪退

**解决方案：**
1. 完全退出应用
2. 清除应用数据（可选）：
   ```bash
   rm -rf ~/Library/Application\ Support/prompt-library-mac/
   ```
3. 重新启动应用

---

## 📝 开发者注意事项

### 打包配置

打包配置位于 `package.json` 的 `build` 字段：

```json
{
  "build": {
    "appId": "com.promptlibrary.mac",
    "productName": "提示词库",
    "mac": {
      "category": "public.app-category.productivity",
      "target": "dir"
    }
  }
}
```

### 打包命令

```bash
# 打包应用（输出到 dist/mac-arm64/）
npm run build

# 仅开发运行
npm start
```

### 数据存储位置

所有用户数据存储在：
```
~/Library/Application Support/prompt-library-mac/
```

包括：
- 提示词数据
- 模式配置
- 应用设置

---

## 🔧 调试技巧

### 1. 查看应用日志

从终端启动查看实时日志：
```bash
npm start
```

### 2. 检查进程

```bash
# 查看是否有应用在运行
ps aux | grep -i "提示词库\|prompt-library"

# 强制终止所有相关进程
pkill -f "Electron.*Slash-Command-Prompter"
```

### 3. 权限测试

```bash
# 测试辅助功能权限
osascript -e 'tell application "System Events" to keystroke "test"'
```

---

## 📞 获取帮助

如果遇到本文档未覆盖的问题：

1. 检查应用日志（从终端启动查看）
2. 查看系统控制台（Console.app）中的错误信息
3. 尝试清除应用数据重新开始

---

## 📜 版本历史

### v2.0.0 (2025-10-29)

**修复的问题：**
- ✅ 修复：辅助功能权限问题 (1002)
- ✅ 修复：write EIO 错误
- ✅ 修复：应用改名后插入功能失效（旧进程干扰）

**新增功能：**
- ✅ 新增：独立打包功能
- ✅ 新增：高清应用图标 (1024x1024)
- ✅ 新增：启动脚本自动化

**改进优化：**
- ✅ 改进：窗口状态管理
- ✅ 改进：错误处理和用户提示
- ✅ 改进：完整的问题排除文档

---

## 3. 应用改名后插入功能失效

### 🔴 问题描述

修改应用名称（如从"提示词库"改为"Prompter"）并重新打包后，发现：
- 插入功能不工作
- 按 `Enter` 选择提示词后没有反应
- 或者应用根本无法启动

**症状：**
- 虽然在辅助功能中已经授权，但插入仍然失败
- 运行的可能还是旧版本的应用
- 打包后的应用文件找不到或被覆盖

### 🔍 问题原因

**多个层面的问题：**

1. **旧进程未停止**
   - 修改名称重新打包后，旧的应用进程可能还在运行
   - macOS 会继续运行旧的应用，而不是新打包的版本
   - 旧应用的名称与新的权限配置不匹配

2. **打包文件被覆盖或清除**
   - electron-builder 打包时会清空 `dist` 目录
   - 如果在打包过程中出错或中断，应用文件可能不完整

3. **权限对象不匹配**
   - 系统辅助功能中授权的是旧应用名称（如"提示词库"）
   - 新应用（如"Prompter"）需要重新授权
   - 即使界面上显示已授权，实际运行的还是旧版本

### ✅ 解决方案

#### 步骤 1：确认当前运行的应用

```bash
# 检查哪个应用正在运行
ps aux | grep -E "Prompter|提示词库|mac-arm64" | grep -v grep
```

**关键：** 查看输出中的应用路径，确认是否是你想要的版本。

#### 步骤 2：停止所有旧进程

```bash
# 方法1：通过应用名称停止
killall "提示词库" 2>/dev/null
killall "Prompter" 2>/dev/null

# 方法2：如果方法1不起作用，强制停止
# 先获取进程ID，然后强制终止
ps aux | grep "mac-arm64" | grep -v grep | awk '{print $2}' | xargs kill -9
```

**验证进程已停止：**
```bash
ps aux | grep -E "Prompter|提示词库" | grep -v grep
```
应该没有任何输出。

#### 步骤 3：确认打包文件存在

```bash
# 检查应用文件是否存在
ls -la "dist/mac-arm64/"
```

**预期输出：** 应该看到 `Prompter.app`（或你的应用名称）

**如果应用不存在：** 重新打包
```bash
npm run build
```

#### 步骤 4：启动新应用

```bash
open "dist/mac-arm64/Prompter.app"
```

**或使用启动脚本：**
```bash
./启动应用.sh
```

#### 步骤 5：验证新应用正在运行

```bash
ps aux | grep "Prompter" | grep -v grep | head -2
```

**应该看到类似输出：**
```
apple  12345  ... /path/to/Prompter.app/Contents/MacOS/Prompter
```

**关键检查点：** 路径中必须包含 `Prompter.app`，而不是旧的应用名。

#### 步骤 6：重新授权辅助功能

1. **打开系统设置：**
   ```bash
   open "x-apple.systempreferences:com.apple.preference.security?Privacy_Accessibility"
   ```

2. **添加新应用到辅助功能列表：**
   - 点击左下角 **🔒** 解锁（需要密码）
   - 点击列表下方的 **+** 按钮
   - 按 `⌘⇧G` 输入路径（根据你的实际路径）：
     ```
     /Users/apple/mac 提示词库/Slash-Command-Prompter/dist/mac-arm64/
     ```
   - 选择 **Prompter.app**
   - 点击"打开"
   - 确保开关是**开启**状态（紫色/蓝色）

3. **可选：移除旧的授权条目**
   - 如果列表中有旧的"提示词库"或多余的"Electron"条目
   - 选中后点击 **-** 按钮移除（可选）

#### 步骤 7：测试插入功能

1. 打开任何文本编辑器（备忘录、Cursor 等）
2. 按 `Shift + ⌘ + O` 呼出应用窗口
3. 选择一个提示词
4. 按 `Enter` 键

**应该能够正常插入文本了！** ✅

### 💡 预防措施

**避免此问题再次发生：**

1. **修改应用名称后完整流程：**
   ```bash
   # 1. 停止旧应用
   killall "旧应用名" 2>/dev/null
   
   # 2. 重新打包
   npm run build
   
   # 3. 启动新应用
   open "dist/mac-arm64/新应用名.app"
   
   # 4. 重新授权辅助功能
   ```

2. **使用脚本自动化：**
   - 使用项目中的 `启动应用.sh` 脚本
   - 它会自动检查应用是否存在并启动

3. **开发时建议：**
   - 开发调试期间，避免频繁更改应用名称
   - 确定好应用名称后再进行大规模测试

### 📊 故障诊断流程图

```
插入功能不工作
    ↓
检查运行的应用名称是否正确？
    ├─ 否 → 停止旧进程 → 启动新应用
    └─ 是 ↓
         检查辅助功能中是否有该应用？
         ├─ 否 → 添加应用到辅助功能
         └─ 是 ↓
              应用是否开启？
              ├─ 否 → 开启开关
              └─ 是 → 查看其他问题章节
```

### 🔧 相关命令速查

```bash
# 查看所有运行的 Electron 应用
ps aux | grep -i electron | grep -v grep

# 强制停止特定应用
killall -9 "应用名称"

# 检查应用文件是否存在
ls -la "dist/mac-arm64/"

# 重新打包
npm run build

# 启动应用
open "dist/mac-arm64/Prompter.app"

# 打开辅助功能设置
open "x-apple.systempreferences:com.apple.preference.security?Privacy_Accessibility"
```

---

## 4. 应用更新后新功能未生效

### 🔴 问题描述

代码已更新（如搜索排序优化、新增功能等），但在应用中看不到效果。

**症状：**
- 修改了代码文件（如 `app.js`）
- Git 提交显示代码已更改
- 但运行应用时功能表现仍然是旧的
- 控制台看不到新添加的调试信息

### 🔍 问题原因

**核心原因：运行的是旧版本的应用**

Prompter 有两种运行方式：

1. **开发版本** (`npm start`)
   - 直接从源代码运行
   - 修改代码后重启即可生效
   - 位置：项目根目录

2. **打包版本** (`Prompter.app`)
   - 独立的应用包
   - 代码被打包进 `app.asar` 文件
   - 位置：`dist/mac-arm64/Prompter.app`
   - **不会自动更新**，需要重新打包

**常见混淆情况：**
- 修改了源代码，但运行的是打包好的应用
- 打包应用会阻止开发版本启动（单实例锁）
- 使用快捷键呼出的是已在运行的旧版本

### ✅ 解决方案

#### 方案一：切换到开发版本（推荐测试新功能）

1. **关闭打包的应用**
   ```bash
   killall Prompter
   ```

2. **确认进程已停止**
   ```bash
   ps aux | grep Prompter | grep -v grep
   # 应该没有输出
   ```

3. **启动开发版本**
   ```bash
   cd "/Users/apple/mac 提示词库/Slash-Command-Prompter"
   npm start
   ```

4. **使用快捷键测试**
   - 按 `Shift + ⌘ + O` 呼出窗口
   - 新功能应该已生效

5. **查看调试信息**（如有）
   - 在应用窗口按 `Cmd + Option + I` 打开开发者工具
   - 切换到 Console 标签查看日志

#### 方案二：重新打包应用（推荐日常使用）

**注意：** 需要先切换到 `commercial-release` 分支（包含打包工具）

```bash
# 1. 关闭运行中的应用
killall Prompter

# 2. 切换到商业发布分支（如需要）
git checkout commercial-release

# 3. 重新打包
npm run build

# 4. 打包完成后，启动新应用
open "dist/mac-arm64/Prompter.app"
```

**如果在 `main` 分支上：**

`main` 分支没有打包配置，需要手动安装：

```bash
# 安装打包工具
npm install --save-dev electron-builder

# 添加打包脚本到 package.json
# 然后运行
npm run build
```

或者直接切换到 `commercial-release` 分支使用完整配置。

#### 方案三：手动更新打包应用（不推荐）

打包的代码在 `app.asar` 文件中，需要特殊工具解包/重新打包：

```bash
# 安装 asar 工具
npm install -g asar

# 解包
asar extract "dist/mac-arm64/Prompter.app/Contents/Resources/app.asar" temp-app

# 复制新文件
cp app.js temp-app/
cp popup.js temp-app/

# 重新打包
asar pack temp-app "dist/mac-arm64/Prompter.app/Contents/Resources/app.asar"

# 清理临时文件
rm -rf temp-app
```

### 🔍 如何判断运行的是哪个版本？

#### 方法 1：查看进程路径

```bash
ps aux | grep -i electron | grep -v grep
```

**输出示例：**
```
# 开发版本 (npm start)
/usr/local/bin/electron . 

# 打包版本
/Applications/Prompter.app/Contents/MacOS/Prompter
或
.../dist/mac-arm64/Prompter.app/Contents/MacOS/Prompter
```

#### 方法 2：在代码中添加版本标识

在 `app.js` 的开头添加：

```javascript
console.log('🚀 应用版本: 开发版 v2.0.0-dev');
console.log('📅 更新时间:', new Date().toISOString());
```

然后打开开发者工具查看 Console 输出。

#### 方法 3：检查文件修改时间

```bash
# 查看打包应用的创建时间
ls -la "dist/mac-arm64/Prompter.app/Contents/Resources/app.asar"

# 查看源代码的修改时间
ls -la app.js
```

如果源代码的修改时间比打包文件新，说明需要重新打包。

### 💡 最佳实践

1. **开发时使用开发版本**
   - 修改代码后只需重启 `npm start`
   - 可以实时调试

2. **测试时使用打包版本**
   - 更接近用户实际使用场景
   - 测试辅助功能权限等系统集成

3. **分支管理**
   - `main` 分支：核心功能开发
   - `commercial-release` 分支：包含打包配置和商业化功能

4. **避免同时运行两个版本**
   - 单实例锁会导致第二个启动失败
   - 快捷键只能呼出第一个启动的实例

### 📊 常见更新场景

| 更新内容 | 是否需要重新打包 | 建议方法 |
|---------|----------------|----------|
| 搜索逻辑优化 | 开发版：否<br>打包版：是 | 先用开发版测试<br>确认后重新打包 |
| UI 样式调整 | 开发版：否<br>打包版：是 | 同上 |
| 新增功能 | 开发版：否<br>打包版：是 | 同上 |
| 修复 Bug | 开发版：否<br>打包版：是 | 同上 |
| 依赖包更新 | 需要 `npm install` | 两个版本都要重新安装 |
| Electron 版本升级 | 需要 `npm install` | 两个版本都要重新安装和打包 |

### 🚀 快速检查清单

新功能未生效时，按顺序检查：

```
1. ✅ 确认代码已保存
   - 编辑器中没有未保存标记
   
2. ✅ 确认 Git 已提交（可选）
   git status
   
3. ✅ 关闭所有 Prompter 进程
   killall Prompter
   killall Electron
   
4. ✅ 重新启动开发版本
   npm start
   
5. ✅ 按快捷键测试
   Shift + ⌘ + O
   
6. ✅ 打开开发者工具验证
   Cmd + Option + I
```

### 🔧 相关命令速查

```bash
# 查看运行的 Prompter 进程
ps aux | grep Prompter | grep -v grep

# 停止所有相关进程
killall Prompter
killall Electron

# 启动开发版本
cd "/Users/apple/mac 提示词库/Slash-Command-Prompter"
npm start

# 重新打包（commercial-release 分支）
npm run build

# 查看文件修改时间
ls -lht app.js popup.js main.js

# 查看打包应用内容
ls -la "dist/mac-arm64/Prompter.app/Contents/Resources/"

# 比较源代码和打包时间
stat -f "%Sm" app.js
stat -f "%Sm" "dist/mac-arm64/Prompter.app/Contents/Resources/app.asar"
```

---

## 5. 电脑重启后应用异常

### 🔴 问题描述

电脑重启后，再次启动应用时出现以下问题：

**症状1：Error: write EIO 错误**
```
A JavaScript error occurred in the main process
Uncaught Exception:
Error: write EIO
  at afterWriteDispatched (node:internal/stream_base_commons:160:15)
  at writeGeneric (node:internal/stream_base_commons:151:3)
  ...
  at console.warn (node:internal/console/constructor:385:26)
  at s.send (node:electron/js2c/browser_init:2:83036)
```

**症状2：插入功能失效（1002 错误）**
```
Error: Command failed: osascript -e '...'
execution error: "System Events"遇到一个错误："osascript"不允许发送按键。 (1002)
```

**症状3：运行的是开发版本，而不是打包版本**
- 从 Finder 双击 `Prompter.app`，但实际运行的是开发版 Electron
- 应用图标显示不正确
- 之前的设置和数据可能不同步

### 🔍 问题原因

电脑重启后可能出现以下情况：

1. **进程残留问题**
   - 重启前的 Electron 进程可能未正确清理
   - 旧进程占用单例锁，阻止新实例启动
   - 进程间的 stdout/stderr 管道损坏

2. **权限失效**
   - macOS 重启后，某些辅助功能权限可能需要重新激活
   - 打包应用和开发版本需要分别授权

3. **版本混淆**
   - 后台运行着开发版本（`npm start`）
   - 打包版本 `Prompter.app` 因为单例锁无法启动
   - 或者相反：打包版本在运行，但期望使用开发版本

### ✅ 解决方案

#### 步骤1：彻底清理所有 Electron 进程

```bash
# 强制结束所有 Electron 和 Prompter 进程
killall -9 Electron 2>/dev/null
killall -9 Prompter 2>/dev/null

# 等待1-2秒确保进程完全结束
sleep 2
```

#### 步骤2：确定要使用的版本

**选项A：使用打包版本（推荐，更稳定）**

```bash
# 方法1：直接打开
open "/Users/apple/mac 提示词库/Slash-Command-Prompter/dist/mac-arm64/Prompter.app"

# 方法2：使用启动脚本（如果存在）
./启动应用.sh

# 方法3：从 Finder 双击
# 在 Finder 中找到 dist/mac-arm64/Prompter.app，双击打开
```

**选项B：使用开发版本（用于测试新功能）**

```bash
cd "/Users/apple/mac 提示词库/Slash-Command-Prompter"
npm start
```

#### 步骤3：重新授权辅助功能权限

电脑重启后或首次运行不同版本时，需要重新授权：

1. **打开系统设置**
   ```
   系统设置 → 隐私与安全性 → 辅助功能
   ```

2. **根据使用的版本授权**
   - 如果使用**打包版本**：找到并勾选 `Prompter` ✅
   - 如果使用**开发版本**：找到并勾选 `Electron` ✅
   - 如果两个都有，确保使用的那个被勾选

3. **删除旧的无用授权（可选）**
   - 移除不再使用的 `Terminal`、旧的 `Electron` 等授权

4. **完全重启应用**
   ```bash
   # 杀掉应用
   killall Prompter  # 或 killall Electron
   
   # 重新启动
   open "./dist/mac-arm64/Prompter.app"  # 或 npm start
   ```

#### 步骤4：验证问题解决

1. 启动应用（`⌘ + Shift + L`）
2. 搜索任意提示词
3. 点击或按 Enter 选择
4. 检查是否成功粘贴到光标位置

### 🎯 快速诊断流程图

```
电脑重启后应用异常
    │
    ├─ 出现 write EIO 错误？
    │   └─> 执行：killall -9 Electron && 重新启动
    │
    ├─ 出现 1002 错误？
    │   └─> 检查系统设置 → 辅助功能权限
    │       ├─ 使用打包版本？→ 勾选 Prompter
    │       └─ 使用开发版本？→ 勾选 Electron
    │
    └─ 不确定运行的是哪个版本？
        └─> 执行：ps aux | grep -i "prompter\|electron"
            ├─ 看到 "Prompter.app" → 打包版本
            ├─ 看到 "npm start" 或 "node_modules/electron" → 开发版本
            └─ 同时存在？→ killall -9 全部清理，重新选择一个启动
```

### 💡 预防措施

**1. 关机前正确退出应用**
```bash
# 不要直接强制关机，先退出应用
killall Prompter  # 或从菜单栏选择退出
```

**2. 创建启动脚本（一键解决）**

创建 `启动应用.sh`：
```bash
#!/bin/bash

# 清理旧进程
killall -9 Electron 2>/dev/null
killall -9 Prompter 2>/dev/null
sleep 1

# 启动打包版本
APP_PATH="/Users/apple/mac 提示词库/Slash-Command-Prompter/dist/mac-arm64/Prompter.app"

if [ -d "$APP_PATH" ]; then
    echo "启动 Prompter..."
    open "$APP_PATH"
else
    echo "错误：找不到应用，请先打包："
    echo "  cd /Users/apple/mac 提示词库/Slash-Command-Prompter"
    echo "  npm run build"
fi
```

添加执行权限：
```bash
chmod +x 启动应用.sh
```

使用：
```bash
./启动应用.sh
```

**3. 只使用一个版本**
- **日常使用**：只用打包版本 `Prompter.app`
- **开发调试**：临时启动开发版本，用完立即关闭

**4. 定期更新打包版本**

当修改了代码后，记得重新打包：
```bash
npm run build
# 然后使用新打包的 Prompter.app
```

### 📊 常见场景速查

| 场景 | 操作 |
|------|------|
| 电脑重启后首次使用 | `killall -9 Electron Prompter` → `open Prompter.app` → 检查权限 |
| 从开发版切换到打包版 | `killall -9 Electron` → `open Prompter.app` |
| 从打包版切换到开发版 | `killall Prompter` → `npm start` |
| 不确定哪个版本在运行 | `ps aux \| grep -i electron` 查看进程 |
| 打包版本未生效 | 检查是否有开发版本占用单例锁 |
| 权限突然失效 | 系统设置 → 辅助功能 → 取消勾选再重新勾选 |

### 🔧 调试命令

```bash
# 1. 查看所有 Electron 相关进程
ps aux | grep -i "prompter\|electron" | grep -v grep

# 2. 查看打包应用是否存在
ls -la "dist/mac-arm64/Prompter.app"

# 3. 检查打包时间（确认是否是最新版本）
stat -f "%Sm" "dist/mac-arm64/Prompter.app/Contents/Resources/app.asar"

# 4. 检查源代码修改时间
stat -f "%Sm" app.js main.js

# 5. 强制清理并重启（一键脚本）
killall -9 Electron Prompter 2>/dev/null; sleep 2; open "dist/mac-arm64/Prompter.app"
```

---

## 6. 代码更新后打包版本未生效

### 🔴 问题描述

**核心问题：代码已更新并提交到 Git，但打包的应用中没有包含最新功能**

**典型症状：**
1. ✅ 源代码已修改（如 `app.js` 中添加了搜索优化逻辑）
2. ✅ 代码已提交到 Git
3. ✅ 应用能正常运行
4. ❌ **但新功能不生效**（如搜索优先级排序没有作用）
5. ❌ 打包的 `/Applications/Prompter.app` 包含的是旧代码

**具体表现：**
```
修改了 app.js 添加搜索优化
    ↓
提交到 Git ✅
    ↓
打包应用 npm run build ✅
    ↓
打开 /Applications/Prompter.app ❌
    ↓
新功能没有生效！ ❌
```

### 🔍 问题原因

**根本原因：打包后的应用没有复制到 `/Applications/` 目录**

1. **两个不同的应用位置**
   - 📦 **新打包的版本**：`dist/mac-arm64/Prompter.app`（包含最新代码）
   - 🗂️ **实际运行的版本**：`/Applications/Prompter.app`（旧版本）

2. **打包流程不完整**
   ```bash
   npm run build  # ✅ 在 dist/mac-arm64/ 生成了新版本
   # ❌ 但没有复制到 /Applications/
   # ❌ 所以运行的还是旧版本
   ```

3. **版本混淆**
   - 用户以为：打包后就会自动更新到系统应用
   - 实际情况：打包只生成到 `dist/` 目录，需要**手动复制**到 `/Applications/`

4. **缓存问题**
   - 即使复制了，macOS 可能还在使用旧的应用缓存
   - Electron 的 `app.asar` 文件可能被系统缓存

### ✅ 解决方案（标准流程）

#### 完整更新流程（必须按顺序执行）

```bash
# ========================================
# 步骤1：修改代码后重新打包
# ========================================
cd "/Users/apple/mac 提示词库/Slash-Command-Prompter"
npm run build

# ========================================
# 步骤2：停止所有正在运行的 Prompter
# ========================================
killall -9 Prompter 2>/dev/null

# ========================================
# 步骤3：删除旧版本
# ========================================
rm -rf /Applications/Prompter.app

# ========================================
# 步骤4：复制新版本到 /Applications/
# ========================================
cp -R dist/mac-arm64/Prompter.app /Applications/

# ========================================
# 步骤5：清除应用缓存（可选但推荐）
# ========================================
rm -rf ~/Library/Application\ Support/prompt-library-mac

# ========================================
# 步骤6：启动新版本
# ========================================
open /Applications/Prompter.app

# ========================================
# 步骤7：验证新功能
# ========================================
# 按 ⌘ + Shift + L 唤出应用
# 测试新功能是否生效
```

### 🚀 一键更新脚本（推荐）

创建 `update-app.sh`：

```bash
#!/bin/bash

echo "🔄 开始更新 Prompter..."

# 1. 重新打包
echo "📦 1/6 重新打包..."
cd "/Users/apple/mac 提示词库/Slash-Command-Prompter"
npm run build

if [ $? -ne 0 ]; then
    echo "❌ 打包失败！"
    exit 1
fi

# 2. 停止应用
echo "🛑 2/6 停止旧版本..."
killall -9 Prompter 2>/dev/null
sleep 1

# 3. 删除旧版本
echo "🗑️  3/6 删除旧版本..."
rm -rf /Applications/Prompter.app

# 4. 复制新版本
echo "📋 4/6 复制新版本..."
cp -R dist/mac-arm64/Prompter.app /Applications/

if [ ! -d "/Applications/Prompter.app" ]; then
    echo "❌ 复制失败！"
    exit 1
fi

# 5. 清除缓存（可选）
echo "🧹 5/6 清除缓存..."
rm -rf ~/Library/Application\ Support/prompt-library-mac

# 6. 启动新版本
echo "🚀 6/6 启动新版本..."
open /Applications/Prompter.app

echo ""
echo "✅ 更新完成！"
echo ""
echo "📝 验证步骤："
echo "  1. 按 ⌘ + Shift + L 唤出应用"
echo "  2. 测试新功能是否生效"
echo ""
```

**使用方法：**

```bash
# 添加执行权限
chmod +x update-app.sh

# 每次更新代码后运行
./update-app.sh
```

### 🔍 如何验证是否使用了最新版本

#### 方法1：检查打包时间

```bash
# 查看源代码修改时间
ls -lht app.js | head -1

# 查看打包文件时间
ls -lht /Applications/Prompter.app/Contents/Resources/app.asar

# 对比时间：app.asar 应该比 app.js 新或相同
```

#### 方法2：解压检查代码

```bash
# 解压 app.asar 查看代码
npx asar extract /Applications/Prompter.app/Contents/Resources/app.asar /tmp/prompter-verify

# 检查是否包含新功能（以搜索优化为例）
grep -n "score = 1000" /tmp/prompter-verify/app.js

# 应该能找到代码（如果找不到说明是旧版本）
```

#### 方法3：对比文件大小

```bash
# 查看两个版本的 app.asar 大小
ls -lh dist/mac-arm64/Prompter.app/Contents/Resources/app.asar
ls -lh /Applications/Prompter.app/Contents/Resources/app.asar

# 大小应该一致（如果不一致说明版本不同）
```

#### 方法4：查看应用信息

```bash
# 查看打包版本的修改时间
stat -f "%Sm" /Applications/Prompter.app

# 应该是最近的时间（如果是很久之前说明没更新）
```

### 🎯 防止问题再次发生

#### 1. 建立标准工作流程

**每次修改代码后必须执行：**

```
修改代码 (app.js, main.js 等)
    ↓
测试（可选：npm start 测试开发版本）
    ↓
提交代码 (git commit)
    ↓
重新打包 (npm run build)  ← 🔴 必须！
    ↓
更新应用 (./update-app.sh)  ← 🔴 必须！
    ↓
验证新功能 (打开应用测试)  ← 🔴 必须！
```

#### 2. 使用版本号标记

在 `package.json` 中递增版本号：

```json
{
  "version": "2.0.1"  // 每次更新递增
}
```

打包后检查：
```bash
# 查看应用版本
/Applications/Prompter.app/Contents/MacOS/Prompter --version
```

#### 3. 添加更新检查脚本

创建 `check-version.sh`：

```bash
#!/bin/bash

echo "📊 版本检查："
echo ""

# 1. 源代码时间
echo "源代码修改时间："
ls -lht app.js | head -1

# 2. dist 打包时间
echo ""
echo "dist/ 打包时间："
ls -lht dist/mac-arm64/Prompter.app/Contents/Resources/app.asar 2>/dev/null || echo "  未找到"

# 3. 应用安装时间
echo ""
echo "/Applications/ 安装时间："
ls -lht /Applications/Prompter.app/Contents/Resources/app.asar 2>/dev/null || echo "  未找到"

# 4. 对比
echo ""
SRC_TIME=$(stat -f "%m" app.js 2>/dev/null)
DIST_TIME=$(stat -f "%m" dist/mac-arm64/Prompter.app/Contents/Resources/app.asar 2>/dev/null)
APP_TIME=$(stat -f "%m" /Applications/Prompter.app/Contents/Resources/app.asar 2>/dev/null)

if [ -n "$SRC_TIME" ] && [ -n "$APP_TIME" ]; then
    if [ "$SRC_TIME" -gt "$APP_TIME" ]; then
        echo "⚠️  警告：源代码比应用新！需要重新打包！"
    else
        echo "✅ 应用是最新版本"
    fi
fi
```

#### 4. 养成验证习惯

**每次更新后必须验证：**

1. ✅ 检查打包是否成功（`dist/mac-arm64/Prompter.app` 存在）
2. ✅ 检查复制是否成功（`/Applications/Prompter.app` 更新了）
3. ✅ 检查应用能否启动
4. ✅ **检查新功能是否生效**（最重要！）

### 📊 常见场景速查

| 场景 | 原因 | 解决方案 |
|------|------|---------|
| 修改代码后功能不生效 | 未重新打包 | `npm run build && ./update-app.sh` |
| 打包后功能还是不生效 | 未复制到 /Applications/ | `cp -R dist/mac-arm64/Prompter.app /Applications/` |
| 复制后还是不生效 | 缓存问题 | 清除缓存：`rm -rf ~/Library/Application\ Support/prompt-library-mac` |
| 不确定是否最新版本 | 版本混淆 | 运行 `./check-version.sh` 检查 |
| 图标未更新 | 图标缓存 | `killall Dock` 重启 Dock |

### 🐛 调试命令

```bash
# 1. 查看当前运行的是哪个应用
ps aux | grep Prompter | grep -v grep

# 2. 对比文件时间戳
stat -f "%Sm %N" app.js
stat -f "%Sm %N" /Applications/Prompter.app/Contents/Resources/app.asar

# 3. 查看应用包内容
ls -la /Applications/Prompter.app/Contents/Resources/

# 4. 验证代码是否在打包中
npx asar list /Applications/Prompter.app/Contents/Resources/app.asar | grep app.js

# 5. 提取并检查代码
npx asar extract /Applications/Prompter.app/Contents/Resources/app.asar /tmp/check
grep "你的新功能关键代码" /tmp/check/app.js
```

### 💡 最佳实践

#### 开发流程建议

1. **开发时使用开发版本**
   ```bash
   npm start  # 启动开发版本，修改代码后自动重载
   ```

2. **测试通过后再打包**
   ```bash
   # 开发版本测试 OK 后
   npm run build
   ./update-app.sh
   ```

3. **打包前提交代码**
   ```bash
   git add .
   git commit -m "feat: 添加新功能"
   npm run build
   ./update-app.sh
   ```

4. **定期清理旧版本**
   ```bash
   # 清理 dist 目录
   rm -rf dist/
   
   # 重新打包
   npm run build
   ```

#### 文件组织建议

```
Slash-Command-Prompter/
├── dist/                    # 打包输出（每次打包生成）
│   └── mac-arm64/
│       └── Prompter.app    # 🔄 临时打包结果
├── update-app.sh           # ⭐ 一键更新脚本
├── check-version.sh        # ⭐ 版本检查脚本
├── app.js                  # 源代码
└── package.json

/Applications/
└── Prompter.app            # 🎯 实际运行的应用
```

### ⚠️ 关键警告

**❌ 常见错误：**

1. **只运行 `npm run build`，不复制到 `/Applications/`**
   - 结果：新版本在 `dist/`，但运行的还是旧版本

2. **直接修改 `/Applications/Prompter.app/` 的代码**
   - 结果：下次打包会覆盖修改

3. **在不同位置维护多个版本**
   - `/Applications/Prompter.app`
   - `~/Desktop/Prompter.app`
   - `dist/mac-arm64/Prompter.app`
   - 结果：版本混乱，不知道哪个是最新的

**✅ 正确做法：**

1. **只维护一个源代码目录**
2. **只从 `dist/mac-arm64/` 复制到 `/Applications/`**
3. **每次更新都走完整流程**
4. **更新后必须验证新功能**

---

**最后更新：** 2025-10-29  
**适用版本：** v2.0.0+

