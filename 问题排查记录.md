# 问题排查记录

本文档记录项目开发过程中遇到的典型问题及解决方案，供将来参考。

---

## 问题 1: 调整窗口初始大小并重新打包应用

### 📅 日期
2025-11-02

### 🔍 问题描述
- 需要调整应用窗口初始打开时的大小，让边框更小一点
- 需要重新打包应用，但必须保证：
  - 应用名称、图标与之前版本完全一致
  - 已有的提示词数据不丢失
  - 用户无感知升级

### 🐛 问题原因
1. **窗口尺寸问题**：初始尺寸在 `main.js` 中的 `createWindow()` 函数中硬编码
2. **打包配置缺失**：项目缺少完整的打包配置和高分辨率图标
3. **数据存储关联**：应用数据存储路径由 `package.json` 中的 `name` 字段决定

### ✅ 解决方案

#### 1. 调整窗口初始大小

**文件位置**：`main.js` 第 47-51 行

**修改前**：
```javascript
mainWindow = new BrowserWindow({
  width: 394,
  height: 646,
  x: Math.floor((width - 394) / 2),
  y: Math.floor((height - 646) / 2),
```

**修改后**：
```javascript
mainWindow = new BrowserWindow({
  width: 360,
  height: 580,
  x: Math.floor((width - 360) / 2),
  y: Math.floor((height - 580) / 2),
```

**说明**：
- 宽度从 394px 缩小到 360px（减少 34px）
- 高度从 646px 缩小到 580px（减少 66px）
- 同时调整居中位置的计算

#### 2. 准备打包资源

**复制高分辨率图标**：
```bash
# 从之前的项目复制高分辨率图标
cp "/Users/apple/mac 提示词库/Slash-Command-Prompter/images/icon1024.png" "./images/"
cp "/Users/apple/mac 提示词库/Slash-Command-Prompter/images/icon512.png" "./images/"
```

**说明**：Mac 应用建议使用 512×512 或 1024×1024 的高分辨率图标

#### 3. 配置打包参数

**文件位置**：`package.json`

**关键配置**：
```json
{
  "name": "prompt-library-mac",           // ⚠️ 决定数据存储路径，不能改
  "productName": "Prompter",              // 应用显示名称
  "version": "2.0.0",
  "scripts": {
    "start": "electron .",
    "dev": "electron . --dev",
    "build": "electron-builder --mac --dir",
    "build:dmg": "electron-builder --mac dmg"
  },
  "devDependencies": {
    "electron": "^28.0.0",
    "electron-builder": "^24.13.3"
  },
  "dependencies": {
    "electron-store": "^8.1.0"
  },
  "build": {
    "appId": "com.prompter.app",          // Bundle ID，保持一致
    "productName": "Prompter",            // 应用名称
    "mac": {
      "category": "public.app-category.productivity",
      "icon": "images/icon1024.png"      // 高分辨率图标
    },
    "files": [
      "**/*",
      "!**/*.md",
      "!dist/**/*",
      "!.git/**/*"
    ],
    "directories": {
      "output": "dist"
    }
  }
}
```

#### 4. 执行打包

```bash
# 1. 安装依赖（包括 electron-builder）
npm install

# 2. 打包应用（生成 .app 文件）
npm run build

# 3. 可选：生成 DMG 安装包
npm run build:dmg
```

#### 5. 验证打包结果

```bash
# 检查生成的应用
ls -lh dist/mac-arm64/

# 验证应用配置信息
plutil -p "dist/mac-arm64/Prompter.app/Contents/Info.plist" | grep -E "CFBundleDisplayName|CFBundleIdentifier"
```

**期望输出**：
```
"CFBundleDisplayName" => "Prompter"
"CFBundleIdentifier" => "com.prompter.app"
```

### 📋 验证清单

- [x] 窗口初始大小已调整（360×580）
- [x] 应用名称保持一致（Prompter）
- [x] Bundle ID 保持一致（com.prompter.app）
- [x] 数据存储名称保持一致（prompt-library-mac）
- [x] 使用高分辨率图标（icon1024.png）
- [x] 打包成功无错误
- [x] 新应用能正常启动
- [x] 快捷键 Shift+Cmd+O 正常工作
- [x] 已有提示词数据能正常加载

### 💡 重要注意事项

1. **数据存储路径**：
   - 应用数据存储在：`~/Library/Application Support/prompt-library-mac/`
   - 路径由 `package.json` 中的 `name` 字段决定
   - ⚠️ 不要修改 `name` 字段，否则会找不到旧数据

2. **应用标识一致性**：
   - `productName`：用户看到的应用名称
   - `appId`：Bundle ID，系统识别应用的唯一标识
   - 这两者必须与旧版本保持一致，否则系统会认为是新应用

3. **图标要求**：
   - 建议使用 512×512 或 1024×1024 的 PNG 图片
   - electron-builder 会自动转换为 .icns 格式
   - 低分辨率图标在 Retina 屏幕上会模糊

4. **代码签名警告**：
   - 如果没有 Apple 开发者证书，会看到签名警告
   - 不影响应用功能，但首次打开时可能需要在"系统设置 > 隐私与安全性"中允许

5. **替换旧版本**：
   - 先退出旧应用
   - 将新的 `Prompter.app` 拖到应用程序文件夹
   - 选择"替换"即可

### 🔗 相关文件
- `main.js` - 窗口配置
- `package.json` - 打包配置
- `images/icon1024.png` - 应用图标

### 📚 参考资源
- [Electron Builder 官方文档](https://www.electron.build/)
- [Electron 窗口配置](https://www.electronjs.org/docs/latest/api/browser-window)

---

## 问题 2: 打包时代码同步问题

### 📅 日期
2025-11-02

### 🔍 问题描述
- 有两个项目目录：旧项目持续更新功能，新项目用于调整窗口大小后打包
- 每次打包时需要手动检查两个项目的差异，确保新项目包含旧项目的所有更新
- 如果忘记同步，打包出来的应用会缺少最新功能
- 需要一个自动化的方法来保持代码同步

### 🐛 问题原因
1. **多项目管理**：同时维护两个版本的代码
2. **手动同步易错**：容易忘记同步或遗漏文件
3. **差异难追踪**：不清楚哪些文件有更新

### ✅ 解决方案

#### 方案 1：使用同步打包脚本（推荐）

创建自动化脚本 `sync-and-build.sh`，每次打包前自动同步代码：

**脚本功能**：
1. 从源项目同步所有最新文件
2. 自动应用窗口大小修改（360×580）
3. 显示差异对比供确认
4. 询问是否继续打包
5. 执行打包流程

**使用方法**：
```bash
# 进入项目目录
cd "/Users/apple/mac 提示词库权限更新/Full-screen-prompt"

# 运行同步打包脚本
./sync-and-build.sh
```

**脚本特点**：
- ✅ 自动同步最新代码
- ✅ 保留窗口大小修改
- ✅ 显示差异便于验证
- ✅ 一键完成同步+打包
- ✅ 排除不必要的文件（node_modules、dist、.git）

#### 方案 2：手动同步流程

如果不使用脚本，可以按以下步骤手动同步：

```bash
# 1. 同步所有文件
rsync -av \
  --exclude='node_modules' \
  --exclude='dist' \
  --exclude='.git' \
  --exclude='package-lock.json' \
  "/Users/apple/mac 提示词库/Slash-Command-Prompter/" \
  "/Users/apple/mac 提示词库权限更新/Full-screen-prompt/"

# 2. 修改窗口大小
# 编辑 main.js，将 width: 394 改为 360，height: 646 改为 580

# 3. 打包
npm run build
```

#### 方案 3：直接在新项目开发（长期方案）

**步骤**：
1. 将新项目作为主项目使用
2. 在新项目中直接开发和更新功能
3. 需要打包时只需运行 `npm run build`
4. 旧项目作为历史备份保留

**优点**：
- 不需要维护两个项目
- 不需要同步操作
- 更简单直接

**设置方法**：
```bash
# 将新项目设置为 Git 主分支
cd "/Users/apple/mac 提示词库权限更新/Full-screen-prompt"
git add .
git commit -m "feat: 优化窗口初始大小为360x580"
git push
```

### 📋 验证清单

使用同步脚本时：
- [x] 脚本已创建并添加执行权限
- [x] 源项目路径正确
- [x] 同步时排除了不必要的文件
- [x] 窗口大小自动修改正确
- [x] 可以查看差异对比
- [x] 打包前有确认提示

### 💡 重要注意事项

1. **源项目路径**：
   - 脚本中的源项目路径：`/Users/apple/mac 提示词库/Slash-Command-Prompter`
   - 如果源项目路径改变，需要修改脚本中的 `SOURCE_DIR` 变量

2. **窗口大小修改**：
   - 脚本使用 `sed` 命令自动替换
   - 替换规则：394→360，646→580
   - 如果手动修改，注意要改4处（width、height、x、y 的计算）

3. **差异对比**：
   - 脚本会显示 main.js 的差异
   - 正常情况下应该只有窗口大小不同
   - 如果有其他差异，需要检查是否符合预期

4. **定期同步**：
   - 建议每次打包前都运行同步脚本
   - 或者在源项目有重要更新后立即同步

5. **Git 管理**：
   - 同步脚本本身应该提交到 Git
   - 在 .gitignore 中排除 dist 目录
   - 定期提交代码避免丢失

### 🔗 相关文件
- `sync-and-build.sh` - 同步打包脚本
- `main.js` - 窗口配置文件
- `package.json` - 打包配置

### 📚 脚本说明

**sync-and-build.sh 关键部分**：

```bash
# 同步文件
rsync -av --exclude='...' "${SOURCE_DIR}/" "${CURRENT_DIR}/"

# 修改窗口大小
sed -i '' 's/width: 394/width: 360/g' main.js
sed -i '' 's/height: 646/height: 580/g' main.js

# 显示差异
diff -u "${SOURCE_DIR}/main.js" "${CURRENT_DIR}/main.js"

# 打包
npm run build
```

---

## 问题模板（供将来使用）

### 📅 日期
YYYY-MM-DD

### 🔍 问题描述
描述遇到的具体问题...

### 🐛 问题原因
分析问题的根本原因...

### ✅ 解决方案
详细的解决步骤...

### 📋 验证清单
- [ ] 验证项 1
- [ ] 验证项 2

### 💡 重要注意事项
需要特别注意的事项...

### 🔗 相关文件
涉及的文件列表...

---

**文档维护说明**：
- 每次遇到典型问题并解决后，在本文档中添加新的问题记录
- 使用清晰的标题和分类，便于快速查找
- 包含完整的代码示例和命令，确保可复现
- 记录验证步骤，确保解决方案有效

